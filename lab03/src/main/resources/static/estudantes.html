<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudantes</title>
</head>
<body>	
        <h1>Gerenciamento de Estudantes</h1>

        <table>    
            <tr> <td>ID:</td> <td><input type="text" id="txtId"></td> </tr>
            <tr> <td>Nome:</td> <td><input type="text" id="txtNome"></td> </tr>
            <tr> <td>Email:</td> <td><input type="text" id="txtEmail"></td> </tr>
			<tr> <td>Área:</td><td><input type="text" id="txtArea"></td></tr>

            <tr><td></td><td>
                <input type="button" value="Novo" onclick="novoEstudante()" id="btnNovo">
                <input type="button" value="Salvar" onclick="salvarEstudante()" id="btnSalvar">
				<input type="button" value="Cadastrar Área" onclick="cadastrarAreaEstudante(document.getElementById('txtId').value,
                                       document.getElementById('txtArea').value)" id="btnCadastrarArea">
                <input type="button" value="Apagar" onclick="apagarEstudante()" id="btnApagar">
                <input type="button" value="Cancelar" onclick="cancelarEdicao()" id="btnCancelar">
            </td></tr>
        </table> 
		<p id="tituloAreas">Áreas de Interesse:</p>
		<ul id="listaAreas"></ul>
        
		<p style="font-weight:bold" id="paragrafoMensagem"></p>
		
        <table id="tabelaEstudantes">    
            <tr> <th>ID</th> <th>Nome</th> <th>Email</th> </tr>
            <tbody id="corpoTabelaEstudantes"> </tbody>
        </table>

		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 20px;
				height: 100vh;
				box-sizing: border-box;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
			}
			th, tr, td {
				padding: 8px;
				text-align: left;    
			}
		</style>

        <script>
	        const corpoTabela = document.querySelector('#corpoTabelaEstudantes');
	        const paragrafoMensagem = document.querySelector('#paragrafoMensagem');
	        const txtId = document.querySelector('#txtId');
	        const txtNome = document.querySelector('#txtNome');
	        const txtEmail = document.querySelector('#txtEmail');
	        
	        const btnNovo = document.querySelector('#btnNovo');
	        const btnSalvar = document.querySelector('#btnSalvar');
	        const btnApagar = document.querySelector('#btnApagar');
	        const btnCancelar = document.querySelector('#btnCancelar');
	        var criandoNovaArea = false;
	        
	        inicializar();

	        function inicializar() {
	        	criandoNovo = false;
	            paragrafoMensagem.innerHTML = 'Pressione o botão Novo ou selecione um estudante da lista:'
	            txtId.value = '';
	            txtNome.value = '';
	            txtEmail.value = '';
				txtArea.value = '';

	            txtId.disabled = true;
	            txtNome.disabled = true;
	            txtEmail.disabled = true;
				txtArea.disabled = true;
				tituloAreas.style.display = "none";
				listaAreas.innerHTML = '';

	            btnNovo.disabled = false;
	            btnSalvar.disabled = true;
				btnCadastrarArea.disabled = true;
	            btnApagar.disabled = true;
	            btnCancelar.disabled = true;
	            listarTodosEstudantes();            
	        }

	        async function listarTodosEstudantes() {
	            const URL = `/mackenzie/estudantes`;
	            fetch(URL)
	              .then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta;}) 
	              .then(resposta => resposta.json())
	              .then(jsonResponse => preencherTabela(jsonResponse))
	              .catch(function(error) { paragrafoMensagem.innerHTML = "Erro ao listar estudantes (código " + error.message + ")";});
	        }
	        
	        
	        function preencherTabela(estudantes) {
	            var linhasTabela = '';
	            var n = estudantes.length;
	            for (var i = 0; i < n; i++) {
	                var f = estudantes[i];
	                linhasTabela += 
	                `<tr>
						<td><a href="javascript:void(0)" onclick="selecionarEstudante('${f.id}','${f.nome}', '${f.email}')">${f.id}</a></td>
						<td>${f.nome}</td>
						<td>${f.email}</td>
					</tr>`;
	            }
	            corpoTabela.innerHTML = linhasTabela;
	        }

	        function selecionarEstudante(id, nome, email) {
	        	criandoNovo = false;
	            paragrafoMensagem.innerHTML = 'Altere e salve os dados do estudante, ou então apague o registro do estudante.'
	            txtId.value = id;
	            txtNome.value = nome;
	            txtEmail.value = email;

				areasEstudante(id);

	            txtId.disabled = true;
	            txtNome.disabled = false;
	            txtEmail.disabled = false;
				txtArea.disabled = false;
				tituloAreas.style.display = "block";

	            btnNovo.disabled = true;
	            btnSalvar.disabled = false;
				btnCadastrarArea.disabled = false;
	            btnApagar.disabled = false;
	            btnCancelar.disabled = false;  
	        }

			function areasEstudante(id) {
				const urlRelacoes = `mackenzie/area-estudante/estudante/${id}`;
				const urlAreas = `mackenzie/areas`;

				Promise.all([
					fetch(urlRelacoes).then(r => {
						if (!r.ok) throw Error(r.status);
						return r.json();
					}),
					fetch(urlAreas).then(r => {
						if (!r.ok) throw Error(r.status);
						return r.json();
					})
				])
				.then(([relacoes, todasAsAreas]) => {

					const listaCombinada = relacoes.map(r => {
						const area = todasAsAreas.find(a => a.id === r.area.id);
						return {
							relacaoId: r.id,   // ID da tabela AreaEstudante
							areaNome: area.nome
						};
					});

					mostrarAreasDoEstudante(listaCombinada, id);
				})
			}

			function mostrarAreasDoEstudante(areas, estudanteId) {
				const lista = document.getElementById("listaAreas");
				lista.innerHTML = "";

				areas.forEach(item => {
					const li = document.createElement("li");

					// texto da área
					li.textContent = item.areaNome + " ";

					// botão excluir
					const botao = document.createElement("button");
					botao.textContent = "Excluir";
					botao.style.marginLeft = "10px";
					botao.onclick = () => deletarAreaEstudante(item.relacaoId, estudanteId);

					li.appendChild(botao);
					lista.appendChild(li);
				});
			}

			function deletarAreaEstudante(relacaoId, estudanteId) {
				const url = `/mackenzie/area-estudante/${relacaoId}`;

				fetch(url, {
					method: 'DELETE'
				})
				.then(response => {
					if (!response.ok) throw Error(response.status);
					areasEstudante(estudanteId); // atualizar lista
				})
				.catch(error => {
					paragrafoMensagem.innerHTML =
						`Erro ao deletar área do estudante (código ${error.message})`;
				});
			}



			function cadastrarAreaEstudante(estudanteId, areaId) {
				const url = `/mackenzie/area-estudante`;
				if (!areaId) {
					paragrafoMensagem.innerHTML = 'Insira um ID de área válido.';
					return;
				}

				const dadosAreaEstudante = {
					estudanteId: estudanteId,
					areaId: areaId
				};

				fetch(url, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(dadosAreaEstudante)
				})
					.then(response => {
						if (!response.ok) throw Error(response.status);
						return response.json();
					})
					.then(() => areasEstudante(estudanteId))
					.catch(error => {
						paragrafoMensagem.innerHTML =
							`Erro ao cadastrar área do estudante (código ${error.message})`;
					});
			}



	        function novoEstudante() {
	        	paragrafoMensagem.innerHTML = 'Preencha os dados do novo estudante...';
	        	criandoNovo = true;
	        	
	        	txtId.value = '';
	        	txtNome.value = '';
	        	txtEmail.value = '';
	        	
	        	txtId.disabled = true;
	        	txtNome.disabled = false;
	        	txtEmail.disabled = false;
	        	
	        	btnNovo.disabled = true;
	        	btnSalvar.disabled = false;
	        	btnApagar.disabled = true;
	        	btnCancelar.disabled = false;
	        }
	        
	        function salvarEstudante() {
	        	if (criandoNovo) {
	        		criarEstudante();
	        	}
	        	else {
	        		alterarEstudante();
	        	}
	        }
	        
	        async function criarEstudante() {
	        	const URL = `/mackenzie/estudantes`;
	        	const dadosEstudante = {
	        		'nome': txtNome.value,
	        		'email': txtEmail.value

	        	};
	        	const postRequest = {
	        		method: 'POST',
	        		body: JSON.stringify(dadosEstudante),
	        		headers: { 'Content-type': 'application/json' }
	        	};
	        	fetch(URL, postRequest)
	        		.then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta; } )
	        		.then(resposta => resposta.json())
	        		.then(jsonResponse => inicializar())
	        		.catch(function(error) { paragrafoMensagem.innerHTML = 'Erro ao criar novo estudante (código ' + error.message + ')'; } );
	        }
	        
	        async function alterarEstudante() {
	        	const ID = txtId.value;
	        	const URL = `/mackenzie/estudantes/${ID}`;
	        	const dadosEstudante = {
	        		'id': ID,
	        		'nome': txtNome.value,
                    'email': txtEmail.value
	        	};
	        	const putRequest = {
	        		method: 'PUT',
	        		body: JSON.stringify(dadosEstudante),
	        		headers: { 'Content-type': 'application/json' }
	        	};
	        	fetch(URL, putRequest)
	        		.then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta; } )
	        		.then(resposta => resposta.json())
	        		.then(jsonResponse => inicializar())
	        		.catch(function(error) { paragrafoMensagem.innerHTML = 'Erro ao alterar estudante (código ' + error.message + ')'; } );	        	
	        }
	        
	        function cancelarEdicao() {
	        	inicializar();
	        }
	        
	        async function apagarEstudante() {
	        	const ID = txtId.value;
	        	const URL = `/mackenzie/estudantes/${ID}`;
	        	const deleteRequest = {
	        		method: 'DELETE'
	        	};
	        	fetch(URL, deleteRequest)
	        		.then(resposta => { if (!resposta.ok) throw Error(resposta.status); return resposta; } )
	        		.then(resposta => inicializar())
	        		.catch(function(error) { paragrafoMensagem.innerHTML = 'Erro ao apagar estudante (código ' + error.message + ')'; } );	        		
	        }
	        
	    </script>   
</body>
</html>